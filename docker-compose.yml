services:
  db:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: contest
      MYSQL_USER: contestuser
      MYSQL_PASSWORD: contestpass
    ports:
      - "13306:3306"
    volumes:
      - db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  redis:
    image: redis:7-alpine
    ports:
      - "16379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: >
      sh -c "python manage.py migrate &&
             python manage.py collectstatic --noinput &&
             gunicorn config.wsgi:application --bind 0.0.0.0:8000 --workers 3"
    ports:
      - "18000:8000"
    environment:
      - DEBUG=True
      - DATABASE_URL=mysql://contestuser:contestpass@db:3306/contest
      - REDIS_URL=redis://redis:6379/0
      - SECRET_KEY=demo-secret-key-change-this-in-production
      - ALLOWED_HOSTS=localhost,127.0.0.1,backend
      - CORS_ALLOWED_ORIGINS=http://localhost:13000,http://127.0.0.1:13000
      # Google OAuth（実際の値をGoogle Cloud Consoleから取得して設定してください）
      - GOOGLE_OAUTH_CLIENT_ID=your-google-oauth-client-id.apps.googleusercontent.com
      - GOOGLE_OAUTH_CLIENT_SECRET=your-google-oauth-client-secret
      # Twitter OAuth 2.0
      - TWITTER_OAUTH_CLIENT_ID=UjdvcFJJbThkaDF3dU5QM3VNMXg6MTpjaQ
      - TWITTER_OAUTH_CLIENT_SECRET=o4ktidRjGFNiNfoZSrI7CZtxw5hnfySOb_HKCQSDuDQkmRWcLO
      # Twitter API v2 (ツイート自動取得用)
      - TWITTER_API_KEY=yWhhw1Ej3bDHvtKsdqUM8SRNn
      - TWITTER_API_SECRET=BDmNGiZDTHrOzbUShguV8e1tAjMQRf7vSkj1wYRhILHaXk17z1
      - TWITTER_BEARER_TOKEN=AAAAAAAAAAAAAAAAAAAAACpU5wEAAAAAwcTo/5vobZRJsjst21owGPkJGBg=KlowFK8ct53c31EJSnXP11FS2s1eoZsOe8Af3AbAWUnHPiwZ99
    volumes:
      - ./backend:/app
      - media_data:/app/media
      - static_data:/app/staticfiles
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    develop:
      watch:
        - action: sync
          path: ./backend
          target: /app
          ignore:
            - __pycache__/
            - "*.pyc"
            - staticfiles/
            - media/
        - action: rebuild
          path: ./backend/requirements.txt

  celery_worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: celery -A config worker -l info
    environment:
      - DEBUG=True
      - DATABASE_URL=mysql://contestuser:contestpass@db:3306/contest
      - REDIS_URL=redis://redis:6379/0
      - SECRET_KEY=demo-secret-key-change-this-in-production
      # Twitter API v2 (ツイート自動取得用)
      - TWITTER_API_KEY=yWhhw1Ej3bDHvtKsdqUM8SRNn
      - TWITTER_API_SECRET=BDmNGiZDTHrOzbUShguV8e1tAjMQRf7vSkj1wYRhILHaXk17z1
      - TWITTER_BEARER_TOKEN=AAAAAAAAAAAAAAAAAAAAACpU5wEAAAAAwcTo/5vobZRJsjst21owGPkJGBg=KlowFK8ct53c31EJSnXP11FS2s1eoZsOe8Af3AbAWUnHPiwZ99
    volumes:
      - ./backend:/app
      - media_data:/app/media
    depends_on:
      - db
      - redis
      - backend

  celery_beat:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: celery -A config beat -l info
    environment:
      - DEBUG=True
      - DATABASE_URL=mysql://contestuser:contestpass@db:3306/contest
      - REDIS_URL=redis://redis:6379/0
      - SECRET_KEY=demo-secret-key-change-this-in-production
      # Twitter API v2 (ツイート自動取得用)
      - TWITTER_API_KEY=yWhhw1Ej3bDHvtKsdqUM8SRNn
      - TWITTER_API_SECRET=BDmNGiZDTHrOzbUShguV8e1tAjMQRf7vSkj1wYRhILHaXk17z1
      - TWITTER_BEARER_TOKEN=AAAAAAAAAAAAAAAAAAAAACpU5wEAAAAAwcTo/5vobZRJsjst21owGPkJGBg=KlowFK8ct53c31EJSnXP11FS2s1eoZsOe8Af3AbAWUnHPiwZ99
    volumes:
      - ./backend:/app
    depends_on:
      - db
      - redis
      - backend

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    command: npm run dev
    ports:
      - "13000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:18000/api
      - NEXT_PUBLIC_GOOGLE_CLIENT_ID=your-google-oauth-client-id.apps.googleusercontent.com
      - NEXT_PUBLIC_TWITTER_ENABLED=true
      - NODE_ENV=development
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - /app/.next
    depends_on:
      - backend
    develop:
      watch:
        - action: sync
          path: ./frontend
          target: /app
          ignore:
            - node_modules/
            - .next/
        - action: rebuild
          path: ./frontend/package.json

volumes:
  db_data:
  media_data:
  static_data:

